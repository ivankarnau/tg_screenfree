<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ScreenFree Mini-App</title>
  
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Проверка поддержки аудио -->
  <script>
    window.isAudioSupported = !!(window.AudioContext || window.webkitAudioContext);
    window.isGetUserMediaSupported = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
  </script>
  
  <!-- Подключаем Quiet.js ассеты -->
  <script src="/quiet/quiet.js"></script>
  <script>
    // Инициализация Quiet.js
    if (window.isAudioSupported) {
      Quiet.init({
        profilesPrefix: "/quiet/",
        memoryInitializerPrefix: "/quiet/"
      });
    }
  </script>
  <script async src="/quiet/quiet-emscripten.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
  
  <!-- iOS WebView hack -->
  <script>
    // Активация аудиоконтекста по первому клику (требование Safari)
    if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
      document.addEventListener('click', () => {
        try {
          const context = new (window.AudioContext || window.webkitAudioContext)();
          if (context.state === 'suspended') {
            context.resume().then(() => {
              console.log('AudioContext activated for iOS');
            });
          }
        } catch (e) {
          console.error('AudioContext activation error:', e);
        }
      }, { once: true, passive: true });
    }

    // Инициализация Quiet.js через iframe для iOS WebView
    if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.srcdoc = `
        <script src="/quiet/quiet.js"><\/script>
        <script>
          if (window.isAudioSupported) {
            Quiet.init({
              profilesPrefix: "/quiet/",
              memoryInitializerPrefix: "/quiet/"
            });
            parent.postMessage('quiet-loaded', '*');
          }
        <\/script>
      `;
      document.body.appendChild(iframe);
    }
  </script>
</body>
</html>