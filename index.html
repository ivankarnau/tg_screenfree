<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ScreenFree Mini-App</title>

  <!-- Telegram Web-App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    /* флаги окружения */
    window.isIOS      = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    window.isTelegram = navigator.userAgent.includes('Telegram');
  </script>

  <!-- ================================================================
       Quiet: 1) биндинги  (quiet.js создаёт window.Quiet и Module)
       ============================================================== -->
  <script src="/quiet/quiet.js"></script>

  <!-- 2) сразу после quiet.js вызываем Quiet.init()
         (так требует библиотека; wasm загрузится позже)              -->
  <script>
    Quiet.init({
      profilesPrefix:          '/quiet/',   // quiet-profiles.json
      memoryInitializerPrefix: '/quiet/'    // quiet-emscripten.js.mem
    });

    Quiet.addReadyCallback(
      () => {
        console.log('[Quiet] ready (desktop / android)');
        window.postMessage('quiet-ready','*');
      },
      (e) => {
        console.error('[Quiet] init error', e);
        window.postMessage('quiet-failed:' + e, '*');
      }
    );
  </script>

  <!-- 3) wasm-рантайм + .mem    (подгрузится асинхронно) -->
  <script async src="/quiet/quiet-emscripten.js"></script>

  <!-- =================================================================
       iOS WebView workaround: wasm инициализируем в iframe
       ================================================================= -->
  <script>
    if (window.isIOS) {
      const iosBootstrap = () => {
        const frame = document.createElement('iframe');
        frame.style.display = 'none';
        frame.srcdoc = `
          <script src="/quiet/quiet.js"><\/script>
          <script>
            Quiet.init({
              profilesPrefix: '/quiet/',
              memoryInitializerPrefix: '/quiet/'
            });
            Quiet.addReadyCallback(
              () => parent.postMessage('quiet-ready','*'),
              (e)=> parent.postMessage('quiet-failed:'+e,'*')
            );
          <\/script>
          <script async src="/quiet/quiet-emscripten.js"><\/script>
        `;
        document.body.appendChild(frame);
      };

      /* Web-Audio на iOS разблокируется только после первого тапа */
      window.addEventListener('touchstart', iosBootstrap, { once:true });
      window.addEventListener('click',      iosBootstrap, { once:true });
    }
  </script>
</head>

<body>
  <div id="root"></div>

  <!-- React/Vite точка входа -->
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>
