<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ScreenFree Mini-App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Глобальные проверки -->
  <script>
    window.audioContextFixApplied = false;
    window.isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    window.isTelegram = navigator.userAgent.includes('Telegram');
  </script>

  <!-- Quiet.js с улучшенной инициализацией -->
  <script src="/quiet/quiet.js"></script>
  <script>
    function initQuiet() {
      try {
        Quiet.init({
          profilesPrefix: "/quiet/",
          memoryInitializerPrefix: "/quiet/",
          memoryInitializer: "/quiet/quiet-emscripten.js"
        });
        console.log("Quiet.js initialized");
      } catch (e) {
        console.error("Quiet init error:", e);
      }
    }
    
    if (!window.isIOS) {
      initQuiet();
    }
  </script>
</head>
<body>
  <div id="root"></div>
  
  <!-- iOS-specific initialization -->
  <script>
    if (window.isIOS) {
      // Активация аудио через пользовательское взаимодействие
      const activateAudio = () => {
        if (window.audioContextFixApplied) return;
        
        try {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          const context = new AudioContext();
          if (context.state === 'suspended') {
            context.resume().then(() => {
              console.log("AudioContext activated on iOS");
            });
          }
          
          // iOS WebView hack
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.srcdoc = `
            <script src="/quiet/quiet.js"><\/script>
            <script>
              Quiet.init({
                profilesPrefix: "/quiet/",
                memoryInitializerPrefix: "/quiet/"
              });
              parent.postMessage('quiet-loaded', '*');
            <\/script>
          `;
          document.body.appendChild(iframe);
          
          window.audioContextFixApplied = true;
        } catch (e) {
          console.error("iOS audio activation failed:", e);
        }
      };

      // Активируем по любому взаимодействию
      document.addEventListener('click', activateAudio, { once: true });
      document.addEventListener('touchstart', activateAudio, { once: true });
    }
  </script>
  
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>