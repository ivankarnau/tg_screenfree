<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ScreenFree Mini-App</title>

  <!-- Telegram WebApp API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Флаги -->
  <script>
    window.isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    window.isTelegram = navigator.userAgent.includes('Telegram');
  </script>

  <!-- Quiet.js и Emscripten (загружаются в iframe на iOS) -->
  <script>
    function initQuietDirect() {
      Quiet.init({
        profilesPrefix: "/quiet/",
        memoryInitializerPrefix: "/quiet/"
      });
      Quiet.addReadyCallback(
        () => window.postMessage('quiet-ready', '*'),
        (e) => console.error('[Quiet] error', e)
      );
    }

    if (!window.isIOS) {
      const script1 = document.createElement('script');
      script1.src = "/quiet/quiet.js";
      script1.onload = () => {
        const script2 = document.createElement('script');
        script2.src = "/quiet/quiet-emscripten.js";
        script2.onload = initQuietDirect;
        document.head.appendChild(script2);
      };
      document.head.appendChild(script1);
    }
  </script>
</head>
<body>
  <div id="root"></div>

  <!-- iOS: загрузка Quiet через iframe -->
  <script>
    if (window.isIOS) {
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.srcdoc = `
        <script src="/quiet/quiet.js"><\/script>
        <script src="/quiet/quiet-emscripten.js"><\/script>
        <script>
          Quiet.init({
            profilesPrefix: "/quiet/",
            memoryInitializerPrefix: "/quiet/"
          });
          Quiet.addReadyCallback(
            () => parent.postMessage('quiet-ready', '*'),
            (e) => parent.postMessage('quiet-failed:' + e, '*')
          );
        <\/script>
      `;
      document.body.appendChild(iframe);
    }
  </script>

  <!-- React -->
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>
