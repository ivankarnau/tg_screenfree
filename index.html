<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ScreenFree Mini-App</title>

  <!-- Telegram Web-App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- 1) quiet.js (биндинги + объект Module) -->
  <script src="/quiet/quiet.js"></script>

  <!-- 2) libquiet, скомпилированная Emscripten-ом (рантайм + wasm)  -->
  <script async src="/quiet/quiet-emscripten.js"></script>

  <!-- Глобальные флаги -->
  <script>
    window.isIOS      = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    window.isTelegram = navigator.userAgent.includes('Telegram');
  </script>

  <!-- Единая инициализация Quiet.js -->
  <script>
    function initQuiet () {
      Quiet.init({
        profilesPrefix:          "/quiet/",
        memoryInitializerPrefix: "/quiet/",
        onReady () {
          /* подстраховка на случай кастомной сборки libquiet */
          if (typeof Module.intArrayFromString !== 'function') {
            Module.intArrayFromString = function (str) {
              const arr = new Uint8Array(str.length + 1);
              for (let i = 0; i < str.length; i++) arr[i] = str.charCodeAt(i);
              arr[str.length] = 0;
              return arr;
            };
            console.warn('[Quiet] patched missing intArrayFromString');
          }
          console.log('[Quiet] ready');
        },
        onError (e) {
          console.error('[Quiet] init failed:', e);
        }
      });
    }

    /* На iOS ждём первого тапа, чтобы разблокировать Web-Audio */
    if (window.isIOS) {
      const unlock = () => { initQuiet(); window.removeEventListener('touchstart', unlock); };
      window.addEventListener('touchstart', unlock, { once: true });
    } else {
      initQuiet();
    }
  </script>
</head>

<body>
  <div id="root"></div>

  <!-- React-приложение -->
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>
