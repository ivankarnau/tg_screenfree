import React, { useRef, useState, useEffect } from 'react';
import { useTelegram } from '../hooks/useTelegram';
import '../styles/Components/SonicTransfer.css';

const PROFILE_NAME = 'ultrasonic-transfer';

type Props = {
  tokenId: string | null;
  amount: number | null;
  onSuccess?: (payload?: any) => void;
};

export function SonicTransfer({ tokenId, amount, onSuccess }: Props) {
  const { webApp, isIos, showPopup } = useTelegram();
  const [isTransmitting, setTransmitting] = useState(false);
  const [status, setStatus] = useState('');
  const [isQuietReady, setIsQuietReady] = useState(false);
  const txRef = useRef<any>();
  const audioContextRef = useRef<AudioContext | null>(null);

  useEffect(() => {
    const handleQuietReady = () => {
      setIsQuietReady(true);
      setStatus('–ê—É–¥–∏–æ —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞');
    };
    
    const handleQuietFailed = (e: any) => {
      setStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
      showPopup({
        title: '–û—à–∏–±–∫–∞ –∞—É–¥–∏–æ —Å–∏—Å—Ç–µ–º—ã',
        message: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å –∑–≤—É–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏'
      });
    };

    window.addEventListener('quiet-ready', handleQuietReady);
    window.addEventListener('quiet-failed', handleQuietFailed);

    return () => {
      window.removeEventListener('quiet-ready', handleQuietReady);
      window.removeEventListener('quiet-failed', handleQuietFailed);
      if (txRef.current) {
        txRef.current.destroy();
      }
    };
  }, [showPopup]);

  const initAudioContext = async () => {
    if (!audioContextRef.current) {
      audioContextRef.current = new (window.AudioContext || (window as any).webkitAudioContext)();
    }
    if (audioContextRef.current.state === 'suspended') {
      await audioContextRef.current.resume();
    }
    return audioContextRef.current;
  };

  const handleSendToken = async () => {
    if (!tokenId || !amount) {
      showPopup({ title: '–û—à–∏–±–∫–∞', message: '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–∫–µ–Ω –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏' });
      return;
    }

    if (!isQuietReady) {
      showPopup({ 
        title: '–°–∏—Å—Ç–µ–º–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞', 
        message: '–ê—É–¥–∏–æ –º–æ–¥—É–ª—å –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.' 
      });
      return;
    }

    try {
      setTransmitting(true);
      setStatus('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏...');
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      await initAudioContext();

      // –î–ª—è iOS –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –ø–µ—Ä–µ–¥–∞—á–∏
      if (isIos) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      txRef.current = Quiet.transmitter({
        profile: PROFILE_NAME,
        onFinish: () => {
          setStatus('–ü–µ—Ä–µ–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
          setTransmitting(false);
          onSuccess?.();
        },
        onCreateFail: (e: any) => {
          console.error('Transmitter error:', e);
          setStatus(`–û—à–∏–±–∫–∞: ${e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
          setTransmitting(false);
          showPopup({
            title: '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏',
            message: '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥–∞—Ç—á–∏–∫'
          });
        },
        onTransmitFail: () => {
          setStatus('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö');
          setTransmitting(false);
        }
      });

      const payload = JSON.stringify({
        token_id: tokenId,
        amount: amount,
        ts: Date.now()
      });

      setStatus('–ò–¥–µ—Ç –ø–µ—Ä–µ–¥–∞—á–∞...');
      txRef.current.transmit(Quiet.str2ab(payload));
      
    } catch (error: any) {
      console.error('Transmission failed:', error);
      setStatus(`–û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
      setTransmitting(false);
      showPopup({
        title: '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏',
        message: '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–¥–∞—á—É –¥–∞–Ω–Ω—ã—Ö'
      });
    }
  };

  const handleOpenReceiver = () => {
    const RECEIVER_URL = '/receiver.html';
    
    if (webApp?.openLink) {
      webApp.openLink(RECEIVER_URL, { try_instant_view: true });
    } else {
      window.open(RECEIVER_URL, '_blank', 'noopener,noreferrer');
    }
  };

  return (
    <div className={`sonic-transfer ${isTransmitting ? 'sonic-active' : ''}`}>
      <h2 className="sonic-title">–£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞</h2>
      
      <div className="btn-row">
        <button
          onClick={handleSendToken}
          disabled={!tokenId || isTransmitting || !isQuietReady}
          className={`sonic-btn primary ${isTransmitting ? 'active' : ''}`}
        >
          {isTransmitting ? (
            <>
              <span className="spinner"></span>
              –ü–µ—Ä–µ–¥–∞—á–∞...
            </>
          ) : (
            'üì§ –ü–µ—Ä–µ–¥–∞—Ç—å —Ç–æ–∫–µ–Ω'
          )}
        </button>
        
        <button 
          onClick={handleOpenReceiver}
          className="sonic-btn secondary"
        >
          üì• –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
        </button>
      </div>
      
      {status && (
        <div className={`sonic-status ${
          status.includes('–û—à–∏–±–∫–∞') ? 'error' : 
          status.includes('–∑–∞–≤–µ—Ä—à–µ–Ω–∞') ? 'success' : ''
        }`}>
          {status}
        </div>
      )}
      
      {isIos && (
        <div className="ios-hint">
          <strong>–î–ª—è iOS:</strong> –£–≤–µ–ª–∏—á—å—Ç–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å –¥–æ –º–∞–∫—Å–∏–º—É–º–∞ –∏ –ø–æ–¥–Ω–µ—Å–∏—Ç–µ 
          —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ 10-20 —Å–º –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É. –ò–∑–±–µ–≥–∞–π—Ç–µ —Ñ–æ–Ω–æ–≤–æ–≥–æ —à—É–º–∞.
        </div>
      )}
    </div>
  );
}