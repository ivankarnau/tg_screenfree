<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Прием токена</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
    }
    .status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .success {
      color: green;
      border: 1px solid green;
    }
    .error {
      color: red;
      border: 1px solid red;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: #40a7e3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
      width: 100%;
      max-width: 300px;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .ios-notice {
      background: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Режим приема токена</h1>
    <div id="status" class="status">Инициализация...</div>
    <button id="startBtn" disabled>
      <span id="buttonText">Загрузка системы...</span>
    </button>
    
    <div id="iosNotice" class="ios-notice" style="display: none;">
      <strong>Важно для iOS:</strong>
      <ul>
        <li>Нажмите кнопку "Начать прием"</li>
        <li>Увеличьте громкость до максимума</li>
        <li>Поднесите устройства на расстояние 10-20 см</li>
        <li>Избегайте фонового шума</li>
      </ul>
    </div>
  </div>

  <script src="/quiet/quiet.js"></script>
  <script>
    // Конфигурация профиля (должна совпадать с передатчиком)
    const PROFILE = {
      mod_scheme: 'gmsk',
      checksum_scheme: 'crc32',
      inner_fec_scheme: 'v27',
      outer_fec_scheme: 'none',
      frame_length: 40,
      modulation: { 
        center_frequency: 19000, 
        gain: 0.2 
      },
      interpolation: {
        shape: 'rrcos',
        samples_per_symbol: 14,
        symbol_delay: 4,
        excess_bandwidth: 0.35
      },
      encoder_filters: {
        dc_filter_alpha: 0.01
      },
      resampler: {
        delay: 13,
        bandwidth: 0.45,
        attenuation: 60,
        filter_bank_size: 64
      }
    };

    // Инициализация Quiet
    Quiet.init({
      profilesPrefix: "/quiet/",
      memoryInitializerPrefix: "/quiet/",
      libfecPrefix: "/quiet/"
    });

    document.addEventListener('DOMContentLoaded', async function() {
      const statusEl = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      const buttonText = document.getElementById('buttonText');
      const iosNotice = document.getElementById('iosNotice');
      let receiver;
      let audioContext;

      // Проверка iOS
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      if (isIOS) {
        iosNotice.style.display = 'block';
      }

      // Инициализация аудио контекста
      async function initAudioContext() {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          
          // Для iOS требуется взаимодействие пользователя
          if (isIOS && audioContext.state === 'suspended') {
            statusEl.textContent = 'Нажмите "Начать прием" для активации аудио';
            return false;
          }
          
          return true;
        } catch (error) {
          throw new Error('Ошибка инициализации аудио: ' + error.message);
        }
      }

      // Запуск приемника
      async function startReceiver() {
        if (receiver) return;
        
        try {
          statusEl.textContent = 'Ожидание токена...';
          buttonText.innerHTML = '<span class="spinner"></span> Слушаем...';
          startBtn.disabled = true;

          // Активируем аудио контекст для iOS
          if (isIOS && audioContext.state === 'suspended') {
            await audioContext.resume();
          }

          receiver = Quiet.receiver({
            profile: 'ultrasonic-transfer',
            onReceive: function(data) {
              try {
                const str = Quiet.ab2str(data);
                const token = JSON.parse(str);
                
                statusEl.textContent = `Получен токен: ${token.amount}₽`;
                statusEl.className = 'status success';
                buttonText.textContent = 'Успешно!';
                
                // Отправляем данные в основное приложение
                if (window.opener) {
                  window.opener.postMessage({
                    type: 'token-received',
                    data: token
                  }, '*');
                }
                
                // Автозакрытие через 3 секунды
                setTimeout(() => {
                  if (window.Telegram?.WebApp) {
                    Telegram.WebApp.close();
                  } else {
                    window.close();
                  }
                }, 3000);
              } catch (e) {
                statusEl.textContent = 'Ошибка декодирования данных';
                statusEl.className = 'status error';
                buttonText.textContent = 'Попробовать снова';
                startBtn.disabled = false;
                if (receiver) {
                  receiver.destroy();
                  receiver = null;
                }
              }
            },
            onCreateFail: function(e) {
              statusEl.textContent = 'Ошибка создания приемника: ' + e;
              statusEl.className = 'status error';
              buttonText.textContent = 'Попробовать снова';
              startBtn.disabled = false;
            },
            onReceiveFail: function(num_fails) {
              if (num_fails > 3) {
                statusEl.textContent = 'Не удалось получить данные. Проверьте громкость и расстояние.';
                statusEl.className = 'status error';
                buttonText.textContent = 'Попробовать снова';
                startBtn.disabled = false;
                if (receiver) {
                  receiver.destroy();
                  receiver = null;
                }
              }
            }
          });
        } catch (error) {
          statusEl.textContent = 'Ошибка: ' + error.message;
          statusEl.className = 'status error';
          buttonText.textContent = 'Попробовать снова';
          startBtn.disabled = false;
        }
      }

      // Обработчик кнопки
      startBtn.addEventListener('click', startReceiver);

      // Инициализация
      try {
        statusEl.textContent = 'Инициализация аудио системы...';
        
        await initAudioContext();
        
        // Добавляем профиль для приемника
        Quiet.addReadyCallback(() => {
          Quiet.addProfile('ultrasonic-transfer', PROFILE);
          
          statusEl.textContent = 'Готов к приему';
          buttonText.textContent = 'Начать прием';
          startBtn.disabled = false;
        }, (error) => {
          statusEl.textContent = 'Ошибка инициализации: ' + error;
          statusEl.className = 'status error';
          buttonText.textContent = 'Обновить страницу';
        });
      } catch (error) {
        console.error('Initialization error:', error);
        statusEl.textContent = 'Ошибка: ' + error.message;
        statusEl.className = 'status error';
        buttonText.textContent = 'Обновить страницу';
      }
    });
  </script>
</body>
</html>