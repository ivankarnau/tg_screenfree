<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Прием токена</title>
  <link rel="preload" href="/quiet/quiet-emscripten.js.mem" as="fetch" crossorigin>
  <script src="/quiet/quiet.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const statusEl = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      let receiver;

      function initializeQuiet() {
        if (!window.Quiet) {
          statusEl.textContent = 'Ошибка: Quiet.js не загружен';
          return;
        }

        Quiet.init({
          profilesPrefix: '/quiet/',
          memoryInitializerPrefix: '/quiet/',
          libfecPrefix: '/quiet/'
        });

        Quiet.addReadyCallback(
          function() {
            // Добавляем профиль приемника
            Quiet.addProfile('ultrasonic-receive', {
              mod_scheme: 'gmsk',
              checksum_scheme: 'crc32',
              inner_fec_scheme: 'v27',
              outer_fec_scheme: 'none',
              frame_length: 34,
              modulation: { center_frequency: 18500, gain: 0.2 },
              interpolation: {
                shape: 'rrcos',
                samples_per_symbol: 14,
                symbol_delay: 4,
                excess_bandwidth: 0.35,
              }
            });
            
            statusEl.textContent = 'Готов к приему';
            startBtn.disabled = false;
          },
          function(error) {
            statusEl.textContent = 'Ошибка инициализации: ' + error;
          }
        );
      }

      startBtn.addEventListener('click', function() {
        if (receiver) return;
        
        statusEl.textContent = 'Ожидание токена...';
        
        receiver = Quiet.receiver({
          profile: 'ultrasonic-receive',
          onReceive: function(data) {
            try {
              const str = Quiet.ab2str(data);
              const token = JSON.parse(str);
              
              statusEl.textContent = `Получен токен: ${token.amount}₽`;
              statusEl.className = 'success';
              
              if (window.opener) {
                window.opener.postMessage({
                  type: 'token-received',
                  data: token
                }, '*');
              }
              
              setTimeout(() => {
                if (window.Telegram?.WebApp) {
                  Telegram.WebApp.close();
                } else {
                  window.close();
                }
              }, 2000);
            } catch (e) {
              statusEl.textContent = 'Ошибка декодирования';
              statusEl.className = 'error';
            }
          },
          onCreateFail: function(e) {
            statusEl.textContent = 'Ошибка создания приемника: ' + e;
            statusEl.className = 'error';
          },
          onReceiveFail: function() {
            statusEl.textContent = 'Ошибка приема данных';
            statusEl.className = 'error';
          }
        });
      });

      // Для iOS требуется пользовательское действие
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        document.addEventListener('touchstart', initializeQuiet, { once: true });
      } else {
        initializeQuiet();
      }
    });
  </script>
</head>
<body>
  <h1>Режим приема токена</h1>
  <div id="status" class="status">Инициализация...</div>
  <button id="startBtn" disabled>Начать прием</button>
</body>
</html>